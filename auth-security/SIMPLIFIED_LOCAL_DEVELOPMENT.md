# üöÄ Desenvolvimento Local Simplificado - MoverseMais

## üìã **Vis√£o Geral**

Este documento define uma vers√£o **simplificada** da arquitetura de seguran√ßa para desenvolvimento local, mantendo a facilidade de execu√ß√£o que voc√™ j√° tem, mas preparando para produ√ß√£o.

---

## üéØ **Filosofia: Desenvolvimento vs Produ√ß√£o**

### **Desenvolvimento Local (Agora)**
- ‚úÖ **Simplicidade**: Um comando para subir tudo
- ‚úÖ **Velocidade**: Sem complexidade desnecess√°ria
- ‚úÖ **Debugging**: F√°cil de debugar e testar
- ‚úÖ **Flexibilidade**: Mudan√ßas r√°pidas

### **Produ√ß√£o (Futuro)**
- üîí **Seguran√ßa**: Todos os padr√µes implementados
- üîí **Monitoramento**: Logs e m√©tricas completas
- üîí **Compliance**: LGPD e auditoria
- üîí **Escalabilidade**: Preparado para crescimento

---

## üèóÔ∏è **Arquitetura Simplificada para Desenvolvimento**

### **Fluxo Simplificado**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Frontend  ‚îÇ    ‚îÇ   BFF       ‚îÇ    ‚îÇ   Backend   ‚îÇ
‚îÇ   (React)   ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ   (Next.js) ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ   (Spring)  ‚îÇ
‚îÇ   Porta: 5173‚îÇ    ‚îÇ   Porta: 3001‚îÇ    ‚îÇ   Porta: 8080‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **Seguran√ßa M√≠nima para Desenvolvimento**
1. **JWT simples** (sem refresh token)
2. **Valida√ß√£o b√°sica** de headers
3. **Logs simples** (console.log)
4. **Sem rate limiting** (desenvolvimento)
5. **CORS permissivo** (localhost)

---

## üöÄ **Setup Super Simples**

### **1. Docker Compose Unificado**
```yaml
# docker-compose.dev.yml
version: '3.8'
services:
  # Banco de dados
  postgres:
    image: postgres:15
    environment:
      - POSTGRES_DB=moversemais_dev
      - POSTGRES_USER=developer
      - POSTGRES_PASSWORD=dev123
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # Frontend
  frontend:
    build: ./moversemais-store-front
    ports:
      - "5173:5173"
    environment:
      - VITE_BFF_URL=http://localhost:3001
    depends_on:
      - bff

  # BFF
  bff:
    build: ./moversemais-store-graphql
    ports:
      - "3001:3001"
    environment:
      - BACKEND_URL=http://objective:8080
      - USER_SERVICE_URL=http://user:8083
    depends_on:
      - objective
      - user

  # Objective Service
  objective:
    build: ./moversemais-objective
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - DATABASE_URL=postgresql://developer:dev123@postgres:5432/moversemais_dev
    depends_on:
      - postgres

  # User Service
  user:
    build: ./moversemais-user
    ports:
      - "8083:8083"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - DATABASE_URL=postgresql://developer:dev123@postgres:5432/moversemais_dev
    depends_on:
      - postgres

volumes:
  postgres_data:
```

### **2. Comando √önico para Subir Tudo**
```bash
# Criar script simples
# scripts/dev-up.sh
#!/bin/bash
echo "üöÄ Subindo MoverseMais em modo desenvolvimento..."
docker-compose -f docker-compose.dev.yml up --build
```

```bash
# Tornar execut√°vel
chmod +x scripts/dev-up.sh

# Executar
./scripts/dev-up.sh
```

---

## üîß **Implementa√ß√£o Gradual por Servi√ßo**

### **Fase 1: BFF com JWT Simples (Semana 1)**

#### **BFF - Middleware B√°sico**
```typescript
// middleware/auth-simple.ts
import jwt from 'jsonwebtoken'

const JWT_SECRET = 'dev-secret-key' // Apenas para desenvolvimento

export function simpleAuthMiddleware(request: NextRequest) {
  // Para desenvolvimento, aceitar header X-User-Id diretamente
  const userId = request.headers.get('X-User-Id')
  
  if (!userId) {
    // Em desenvolvimento, criar usu√°rio mock
    const mockUserId = 'dev-user-123'
    request.headers.set('X-User-Id', mockUserId)
    request.headers.set('X-Provider', 'google')
    request.headers.set('X-Request-Id', crypto.randomUUID())
    return NextResponse.next()
  }
  
  // Se tiver JWT, validar
  const token = request.headers.get('authorization')?.replace('Bearer ', '')
  if (token) {
    try {
      const payload = jwt.verify(token, JWT_SECRET)
      request.headers.set('X-User-Id', payload.sub)
      request.headers.set('X-Provider', payload.provider)
    } catch (error) {
      // Em desenvolvimento, continuar mesmo com JWT inv√°lido
      console.warn('JWT inv√°lido, continuando com usu√°rio mock')
    }
  }
  
  return NextResponse.next()
}
```

#### **BFF - Configura√ß√£o Simplificada**
```typescript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  async middleware(request) {
    // Aplicar apenas em rotas da API
    if (request.nextUrl.pathname.startsWith('/api/')) {
      return simpleAuthMiddleware(request)
    }
  }
}

module.exports = nextConfig
```

### **Fase 2: Microservi√ßos com Valida√ß√£o B√°sica (Semana 2)**

#### **User Service - Interceptor Simples**
```kotlin
// Interceptor simplificado para desenvolvimento
@Component
class DevSecurityInterceptor : HandlerInterceptor {
    
    override fun preHandle(request: HttpServletRequest, response: HttpServletResponse, handler: Any): Boolean {
        // Em desenvolvimento, apenas logar a requisi√ß√£o
        val userId = request.getHeader("X-User-Id") ?: "dev-user-123"
        val endpoint = request.requestURI
        
        println("üîç [DEV] Acesso: $endpoint - Usu√°rio: $userId")
        
        // Adicionar usu√°rio mock se n√£o existir
        if (request.getHeader("X-User-Id").isNullOrBlank()) {
            request.setAttribute("userId", "dev-user-123")
            request.setAttribute("provider", "google")
        }
        
        return true
    }
}
```

#### **Objective Service - Valida√ß√£o B√°sica**
```kotlin
// Valida√ß√£o simplificada para desenvolvimento
@Service
class DevObjectiveSecurityService {
    
    fun validateUserAccess(objectiveId: UUID, userId: String): Objective {
        val objective = objectiveRepository.findById(objectiveId)
            .orElseThrow { ObjectiveNotFoundException("Objective not found") }
        
        // Em desenvolvimento, permitir acesso se for usu√°rio mock
        if (userId == "dev-user-123" || objective.userId == UUID.fromString(userId)) {
            return objective
        }
        
        throw AuthorizationException("Access denied")
    }
}
```

### **Fase 3: Frontend com Autentica√ß√£o Mock (Semana 3)**

#### **Frontend - Auth Mock para Desenvolvimento**
```typescript
// hooks/useAuth-dev.ts
export const useAuth = () => {
  const [user, setUser] = useState(null)
  const [loading, setLoading] = useState(false)
  
  useEffect(() => {
    // Em desenvolvimento, sempre considerar logado
    setUser({
      id: 'dev-user-123',
      email: 'dev@moversemais.com',
      name: 'Usu√°rio Desenvolvimento',
      provider: 'google'
    })
    setLoading(false)
  }, [])
  
  return {
    user,
    loading,
    isAuthenticated: true
  }
}
```

#### **Frontend - Configura√ß√£o de Desenvolvimento**
```typescript
// config/dev.ts
export const DEV_CONFIG = {
  AUTH_ENABLED: false, // Desabilitar auth em desenvolvimento
  MOCK_USER: {
    id: 'dev-user-123',
    email: 'dev@moversemais.com',
    name: 'Usu√°rio Desenvolvimento'
  },
  BFF_URL: 'http://localhost:3001'
}
```

---

## üìã **Guia Passo a Passo por Servi√ßo**

### **1. Frontend (moversemais-store-front)**

#### **Passo 1: Instalar depend√™ncias**
```bash
cd moversemais-store-front
npm install
```

#### **Passo 2: Configurar vari√°veis de ambiente**
```bash
# .env.development
VITE_BFF_URL=http://localhost:3001
VITE_AUTH_ENABLED=false
VITE_MOCK_USER_ID=dev-user-123
```

#### **Passo 3: Implementar auth mock**
```typescript
// src/hooks/useAuth.ts
export const useAuth = () => {
  if (import.meta.env.VITE_AUTH_ENABLED === 'false') {
    return {
      user: { id: 'dev-user-123', email: 'dev@moversemais.com' },
      loading: false,
      isAuthenticated: true
    }
  }
  
  // Implementa√ß√£o real de auth aqui
}
```

#### **Passo 4: Executar**
```bash
npm run dev
```

### **2. BFF (moversemais-store-graphql)**

#### **Passo 1: Instalar depend√™ncias**
```bash
cd moversemais-store-graphql
npm install
```

#### **Passo 2: Configurar vari√°veis de ambiente**
```bash
# .env.local
BACKEND_URL=http://localhost:8080
USER_SERVICE_URL=http://localhost:8083
JWT_SECRET=dev-secret-key
AUTH_ENABLED=false
```

#### **Passo 3: Implementar middleware simples**
```typescript
// middleware/auth-simple.ts (criar arquivo)
export function simpleAuthMiddleware(request: NextRequest) {
  // Implementa√ß√£o simplificada acima
}
```

#### **Passo 4: Executar**
```bash
npm run dev
```

### **3. Objective Service (moversemais-objective)**

#### **Passo 1: Configurar perfil de desenvolvimento**
```yaml
# src/main/resources/application-dev.yml
spring:
  profiles:
    active: dev
  datasource:
    url: jdbc:postgresql://localhost:5432/moversemais_dev
    username: developer
    password: dev123
  jpa:
    hibernate:
      ddl-auto: update

# Configura√ß√µes de desenvolvimento
dev:
  security:
    enabled: false
  mock:
    user-id: dev-user-123
```

#### **Passo 2: Implementar interceptor de desenvolvimento**
```kotlin
// src/main/kotlin/com/moversemais/objective/config/DevSecurityConfig.kt
@Configuration
@Profile("dev")
class DevSecurityConfig {
    
    @Bean
    fun devSecurityInterceptor(): DevSecurityInterceptor {
        return DevSecurityInterceptor()
    }
}
```

#### **Passo 3: Executar**
```bash
./gradlew bootRun --args='--spring.profiles.active=dev'
```

### **4. User Service (moversemais-user)**

#### **Passo 1: Configurar perfil de desenvolvimento**
```yaml
# src/main/resources/application-dev.yml
spring:
  profiles:
    active: dev
  datasource:
    url: jdbc:postgresql://localhost:5432/moversemais_dev
    username: developer
    password: dev123

dev:
  security:
    enabled: false
```

#### **Passo 2: Implementar interceptor de desenvolvimento**
```kotlin
// Mesmo padr√£o do Objective Service
```

#### **Passo 3: Executar**
```bash
./gradlew bootRun --args='--spring.profiles.active=dev'
```

---

## üéØ **Scripts de Desenvolvimento**

### **1. Script para Subir Tudo**
```bash
#!/bin/bash
# scripts/dev-up.sh

echo "üöÄ Subindo MoverseMais em modo desenvolvimento..."

# Subir banco
echo "üìä Subindo PostgreSQL..."
docker-compose -f docker-compose.dev.yml up -d postgres

# Aguardar banco
echo "‚è≥ Aguardando banco..."
sleep 10

# Subir servi√ßos
echo "üîß Subindo servi√ßos..."
cd moversemais-objective && ./gradlew bootRun --args='--spring.profiles.active=dev' &
cd moversemais-user && ./gradlew bootRun --args='--spring.profiles.active=dev' &
cd moversemais-store-graphql && npm run dev &
cd moversemais-store-front && npm run dev &

echo "‚úÖ Todos os servi√ßos subindo!"
echo "üåê Frontend: http://localhost:5173"
echo "üîó BFF: http://localhost:3001"
echo "üéØ Objective: http://localhost:8080"
echo "üë§ User: http://localhost:8083"
```

### **2. Script para Parar Tudo**
```bash
#!/bin/bash
# scripts/dev-down.sh

echo "üõë Parando MoverseMais..."

# Parar processos
pkill -f "gradlew bootRun"
pkill -f "npm run dev"

# Parar containers
docker-compose -f docker-compose.dev.yml down

echo "‚úÖ Todos os servi√ßos parados!"
```

### **3. Script para Reset do Banco**
```bash
#!/bin/bash
# scripts/dev-reset-db.sh

echo "üóëÔ∏è Resetando banco de dados..."

# Parar servi√ßos
./scripts/dev-down.sh

# Remover volume do banco
docker volume rm moversemais_postgres_data

# Subir novamente
./scripts/dev-up.sh

echo "‚úÖ Banco resetado!"
```

---

## üîÑ **Migra√ß√£o Gradual para Produ√ß√£o**

### **Fase 1: Desenvolvimento (Agora)**
- ‚úÖ Auth mock
- ‚úÖ Valida√ß√£o b√°sica
- ‚úÖ Logs simples
- ‚úÖ CORS permissivo

### **Fase 2: Staging (Pr√≥ximo)**
- üîÑ JWT real
- üîÑ Valida√ß√£o de headers
- üîÑ Logs estruturados
- üîÑ CORS restritivo

### **Fase 3: Produ√ß√£o (Futuro)**
- üîí OAuth completo
- üîí Rate limiting
- üîí Monitoramento
- üîí Compliance LGPD

---

## üìã **Checklist de Implementa√ß√£o Simplificada**

### **Semana 1: BFF**
- [ ] Configurar middleware simples
- [ ] Adicionar perfil de desenvolvimento
- [ ] Testar comunica√ß√£o com frontend

### **Semana 2: Microservi√ßos**
- [ ] Adicionar interceptors de desenvolvimento
- [ ] Configurar perfis de desenvolvimento
- [ ] Testar comunica√ß√£o BFF ‚Üí Backend

### **Semana 3: Frontend**
- [ ] Implementar auth mock
- [ ] Configurar vari√°veis de ambiente
- [ ] Testar fluxo completo

### **Semana 4: Scripts e Documenta√ß√£o**
- [ ] Criar scripts de desenvolvimento
- [ ] Documentar comandos
- [ ] Testar setup completo

---

## üö® **Troubleshooting para Desenvolvimento**

### **Problema: Servi√ßo n√£o sobe**
```bash
# Verificar se porta est√° em uso
lsof -ti:8080
kill -9 $(lsof -ti:8080)

# Verificar logs
tail -f logs/application.log
```

### **Problema: Banco n√£o conecta**
```bash
# Verificar se PostgreSQL est√° rodando
docker ps | grep postgres

# Resetar banco
./scripts/dev-reset-db.sh
```

### **Problema: CORS no frontend**
```typescript
// Adicionar no BFF para desenvolvimento
const corsOptions = {
  origin: ['http://localhost:5173'],
  credentials: true
}
```

---

**√öltima Atualiza√ß√£o**: Outubro 2025  
**Vers√£o**: 1.0  
**Mantenedor**: Equipe MoverseMais

---

*Este documento foca na simplicidade para desenvolvimento local, mantendo a base para evolu√ß√£o para produ√ß√£o.*
